#
# Virtual Hosts
#
# If you want to maintain multiple domains/hostnames on your
# machine you can setup VirtualHost containers for them. Most configurations
# use only name-based virtual hosts so the server doesn't need to worry about
# IP addresses. This is indicated by the asterisks in the directives below.
#
# Please see the documentation at 
# <URL:http://httpd.apache.org/docs/2.2/vhosts/>
# for further details before you try to setup virtual hosts.
#
# You may use the command line option '-S' to verify your virtual host
# configuration.

#
# Use name-based virtual hosting.
#
NameVirtualHost *:80

#
# VirtualHost example:
# Almost any Apache directive may go into a VirtualHost container.
# The first VirtualHost section is used for all requests that do not
# match a ServerName or ServerAlias in any <VirtualHost> block.
#
<VirtualHost *:80>

     ServerName localhost
     UseCanonicalName On
     
     DocumentRoot /Users/reshadn/netpulse/server-galaxy-front-end/app
#      <DirectoryMatch  /\.git/|/\.svn/ >
#       Deny from all
#     </DirectoryMatch>
#     <Directory "/Users/reshadn/netpulse/server-galaxy-front-end/app">
#      Options FollowSymLinks
#      AllowOverride None
#      Order allow,deny
#      Allow from all
#     </Directory>

     RewriteEngine On
     # Uncomment for rewrite debugging
#     RewriteLog /var/log/httpd/http_rewrite_log
#     RewriteLogLevel 9

     # <CUSTOM RULES BEFORE ANYTHING BEGIN>

     # <CUSTOM RULES BEFORE ANYTHING END>

     # Enable status page for monitoring purposes 
     RewriteCond %{REMOTE_ADDR} ^(127.0.0.1)
     RewriteRule ^(/server-status) $1 [H=server-status,L]

     # Redirects to a maintenance page if the specified file below exists
     # ...but it still allows images to be served
     RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
     RewriteCond %{SCRIPT_FILENAME} !/system/maintenance.html
     RewriteCond %{SCRIPT_FILENAME} !^(.+).(gif|png|jpg|css|js|swf)$
     RewriteRule ^.*$ /system/maintenance.html [L]

     # Setup the logs in the appropriate directory
#     CustomLog /var/log/httpd/access.log combined
     #ErrorLog  /var/log/httpd/error.log

     #Remote logging -- handle by syslog
     ErrorLog "|logger -p local3.info -t httperror"
     CustomLog "|logger -p local3.info -t https" combined

     LogLevel warn

     #
     # CORS headers
     #
     SetEnvIf Request_Method OPTIONS preflight=1

     Header set Access-Control-Allow-Origin "*"

     Header set Access-Control-Allow-Methods "POST, GET, DELETE, PUT, OPTIONS" env=preflight
     Header set Access-Control-Allow-Headers "accept, origin, x-requested-with, Content-Type" env=preflight

     Header set Access-Control-Allow-Credentials "true" env=!preflight

     # GALAXY_ASSETS: the base directory for static assets for the Galaxy site
     # (Defined in /etc/sysconfig/httpd)
#     PassEnv GALAXY_ASSETS
#
     # Determine which co-brand skin to use, by looking at each user request
     # for the following (in order):
     #
     # 1) Query string parameter ("brand=<brand name>")
     # 2) Cookie ("brand=<brand name>")
     # 3) Server or subdomain name ("<brand name>.netpulse.com")
     # 4) Server domain name ("<brand name>.com")
     # (Default: "netpulse")
     #
     # Once the brand has been determined, it is set within a cookie that will
     # expire at the end of the user's browser session.
     #
     RewriteCond %{QUERY_STRING} ^.*brand=([\w\-]+) [OR]
     RewriteCond %{HTTP_COOKIE} brand=([\w\-]+)
     RewriteRule .* - [E=brand:%1]

     RewriteCond %{ENV:brand} ![\w\-]+
     RewriteCond %{HTTP_HOST} !(?:ec2|s2|api|\-fe\-[0-9])\.netpulse\.(?:com|net|ws)$
     RewriteCond %{HTTP_HOST} ([\w\-]+)\.netpulse\.(?:com|net|ws)$
     RewriteRule .* - [E=brand:%1]

     RewriteCond %{ENV:brand} ![\w\-]+
     RewriteCond %{HTTP_HOST} ([\w\-]+)\.(?:com|net|ws)$
     RewriteRule .* - [E=brand:%1]

     RewriteCond %{ENV:brand} ![\w\-]+
     RewriteRule .* - [E=brand:thelab]

     RewriteRule .* - [CO=brand:%{ENV:brand}:%{HTTP_HOST}] 

     # Galaxy dynamic requests: forward to tomcat
     RewriteCond %{REQUEST_URI} ^/np.*
     RewriteCond %{QUERY_STRING} brand=
     RewriteRule ^(.*) http://127.0.0.1:8080$1 [P,QSA,L]
     
     RewriteCond %{REQUEST_URI} ^/np.*
     RewriteRule ^(.*) http://127.0.0.1:8080$1?brand=%{ENV:brand} [P,QSA,L]

     # Galaxy static assets: read from brand-specific asset directory.
     # If they can't be found there, look for them in the default
     # (netpulse) directory.  If all else fails, proxy the request to
     # the app server.
     RewriteCond %{ENV:brand} !netpulse
     RewriteCond "%{DOCUMENT_ROOT}/brands/%{ENV:brand}/%{REQUEST_FILENAME}" -f
     RewriteRule ^ "%{DOCUMENT_ROOT}/brands/%{ENV:brand}/%{REQUEST_FILENAME}" [L]

     RewriteCond "%{DOCUMENT_ROOT}/%{REQUEST_FILENAME}" -f
     RewriteRule ^ "%{DOCUMENT_ROOT}/%{REQUEST_FILENAME}" [L]

     # Deflate
     AddOutputFilterByType DEFLATE text/html text/plain text/xml application/xml application/xhtml+xml text/javascript text/css application/x-javascript
     BrowserMatch ^Mozilla/4 gzip-only-text/html
     BrowserMatch ^Mozilla/4.0[678] no-gzip
     BrowserMatch bMSIE !no-gzip !gzip-only-text/html

     SetEnvIf User-Agent ".*MSIE.*" nokeepalive ssl-unclean-shutdown downgrade-1.0 force-response-1.0

</VirtualHost>

